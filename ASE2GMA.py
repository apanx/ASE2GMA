import sys
import os
import re
import struct

def main(argv):
    GMA_boilerplate = "2020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202E2E2E2E202C2E2D2D2D2D2E2E20202020202020200A20202020202020202020202020202020202020202020202020202020202020202020202020202020205F5F20202E2D6020202F202F2020202020205F20602D2E20202020200A202020202020202020202020202020202020202020202020202020202020202020202020202020202F20205C602020202028202820202020202C272F20202020602E2020200A20202020202020202020202020202020202020202020202020202020202020202020202020202028202F20205C5F5F202020602D6020202E27202F2E2E2D2760272D2E20200A20202020202020202020202020202020202020202020202020202020202020202020202020202F7C207C2020202020602D2D5F5F5F532720202F20202020202020202029200A2020202020202020202020202020202020202020202020202020202020202020202020202041202820272E2020205F5F5F5F5F5F20202020272020202020202E2D276020200A2020202020202020202020202020202020202020202020202020202020202020202020207C205C205C202020207C202020205F5F5C20202F20603A20202E272820205F5F200A2020202020202020202020202E2D2D3A2D2D2D2C202020202020202020202020202020207C20203A285C5F20206C2020202F202E2D29207C272E7C5C2F20202060285F205C0A202020202020202020202E2720202F2020202020602D2E202020202020202020202020207C2020203A20202020205C2028202857577C205C57296A20602E5F5F5F5F5F5F2F0A20202020202020202E272020207C202020202020202020602E20202020202020202020207C20202020272E202020205C5F5C5F605F7C202060602D2E2020202020202020200A20202020202020207C2020202E272020202020202020202020602C2020202020202020205C2020202020203A20202020202020202020205C5F5F2F202020202020202020200A202020202020202E272020207C20202020202020202020202020205C2020202020202020205C202020202020272E202D2C5F5F5F5F5F5F2E2D2720202020202020202020200A202020202020207C202020207C202020202020202E2D2D2E202020205F5F5F5F5F5F5F5F5F5F602E5F5F20202020272E20202F2020202020202020202020202020202020200A202020202020207C202020207C20202020202E2720202020602E2D27202020202020202020202E2F205F29202020207C2028202020202020202020202020202020202020200A202020202020207C2020202020602E20207C2020202020202F202020204120202020202020207C5C5F5F5F5F5F5F2D7C20205C2020202020202020202020202020202020200A20202020202020272E202020202020272E2720202020207C20204120205620202020202020207C20202020202020207C2020207C20202020202020202020202020202020200A20202020202020207C2020202020202020272E5F5F5F2E7C20205620202020412020202020207C20202020202020207C2020207C20202020202020202020202020202020200A20202020202020207C2020202020202020202020202F207C20202020202020562020202020205C5F5F5F5F5F5F5F2F202020207C20202020202020202020202020202020200A2020202020202020203A2E2020202020202020202F202F205C20202020202020202F202020202020202020202020205C5F5F2F2020202020202020202020202020202020200A20205F5F5F20202E602020272E202020202020282D272020207C2020202020202F2D2C5F5F5F5F5F5F5F5C202020202020205C2020202020202020202020202020202020200A202F205F205C277C2020726020272D2E202020205C20205F2F2020202020202F20202020207C202020207C5C202020202020205C20202020202020202020202020202020200A2820285F5F2F207C20207C202020205C272D2E5F5F5C2F202020202020202F20202020207C20202020207C20602D2D2C202020205C202020202020202020202020202020200A205C5F5F5F5F2F7C20206C20202020207C5C202020207C2020202020207C2020202020207C20202020207C2020202F202020202020292020202020202020202020202020200A2020202020202027202020602E5F5F2F20205C5F5F2F7C2020202020207C2020202020207C2020202020207C2028202020202020207C2020202020202020202020202020200A2020202020202020602D2D2D2D2720202020202020207C2020202020207C2020202020207C2020202020207C20205C2020202020207C2020202020202020202020202020200A202020202020202020202020202020202020202020207C202020202020205C20202020207C202020202020205C2020602E5F5F5F2F202020202020202020202020202020200A20202020202020202020202020202020202020202020205C5F5F5F5F5F5F5F2920202020205C5F5F5F5F5F5F5F2920202020202020202020202020202020202020202020200A2020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020200A"
    if len(argv) > 1:
        filename = argv[1]

    else:
        from Tkinter import Tk
        from tkFileDialog import askopenfilename
        
        Tk().withdraw()
        filename = askopenfilename(filetypes=[('ASE-model', '*.ase'), ('All files', '*.*')])
        if filename =='':
            sys.exit(0)

    ASE_file = open(filename, 'r')
    ASE_data = ASE_file.readlines()
    ASE_file.close

    startcurly = re.compile(r'(\s*)(.+)\s{$')
    meshsmoothing = re.compile(r'AB:.+?BC:.+?CA:.+?MESH_SMOOTHING.+?MESH')
    meshface = re.compile(r'MESH_FACE\s*([0-9]+):\s*A:\s*([0-9]+)\s*B:\s*([0-9]+)\s*C:\s*([0-9]+)\s*\*MESH_MTLID\s*([0-9]+)')
    RGBcolor = re.compile(r'(\s*)(\*MATERIAL.+|\*SCENE.+|\*LIGHT.+)\s([0-9.]+)\t([0-9.]+)\t([0-9.]+)')
    remove = re.compile(r'(.+INHERIT_.+|.+TM_POS.+|.+TM_ROT.+|.+TM_SCALE.+|.+PROP_.+|.+MAP_SUBNO.+)\n')
    fix_path =  re.compile(r'(.+)BITMAP "(.+)"')
    remove_quotes = re.compile(r'"(.+)"')
    fix_backfacecull = re.compile(r'(.+)MATERIAL_REF (.+)')

    for index, line in enumerate(ASE_data):
        ASE_data[index] = startcurly.sub(r'\1\2\n\1{', line)
        ASE_data[index] = meshsmoothing.sub(r'\t*MESH', ASE_data[index])
        ASE_data[index] = meshface.sub(r'MESH_FACE\t\1\tA:\t\2\tB:\t\3\tC:\t\4\t*MESH_MTLID\t\5', ASE_data[index])
        color = RGBcolor.match(ASE_data[index])
        if color:
            hexcolor = int(float(color.group(3)) * 0xff) * 0x10000 + int(float(color.group(4)) * 0xff) * 0x100 + int(float(color.group(5)) * 0xff)
            hexcolor = hex(hexcolor)
            ASE_data[index] = "{}{}\t{}\n".format(color.group(1), color.group(2), hexcolor)
        ASE_data[index] = remove.sub('', ASE_data[index])
        map_path = fix_path.match(ASE_data[index])
        if map_path:
            ASE_data[index] = "{}BITMAP {}\n".format(map_path.group(1), os.path.basename(map_path.group(2)))
        material_ref = fix_backfacecull.match(ASE_data[index])
        if material_ref:
            ASE_data[index] = "{}BACKFACE_CULL\t1\n{}MATERIAL_REF\t{}\n".format(material_ref.group(1), material_ref.group(1), material_ref.group(2))
        ASE_data[index] = remove_quotes.sub(r'\1', ASE_data[index])

    GMA_file = open(os.path.splitext(filename)[0] + ".gma", "w")
    GMA_file.writelines(GMA_boilerplate.decode('hex'))
    GMA_file.writelines(ASE_data)
    GMA_file.close

    print "Conversion complete"
    sys.exit(0)

if __name__ == "__main__":
    main(sys.argv)